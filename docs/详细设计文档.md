#### 4.1.X statisticsbl模块

(1)模块概述

statisticsbl模块承担的需求参见需求规格说明文档功能需求及相关非功能需求。

statisticsbl模块的职责及接口参见软件体系结构文档表Y。

(2) 整体结构

根据体系结构的设计，我们将系统分为展示层、控制层、业务逻辑层、数据层。每一层之间为了增加灵活性，我们会添加接口。比如业务逻辑层和数据层之间，我们添加statisticsdataservice.MovieLikeDataService接口。为了隔离业务逻辑职责和逻辑控制职责，我们增加了控制层的StatisticsController，这样StatisticsController会将电影统计数据相关的逻辑处理委托给MovieLikeBL和StatisticsBL。

statisticsbl模块的设计如图XX所示。

![]()

<div style="text-align: center">图XX statisticsbl模块各个类的设计</div>

statisticsbl模块各个类的职责如表XX所示。

<div style="text-align: center">表XX statisticsbl模块各个类的职责</div>

|     模块     |                 职责                 |
| :----------: | :----------------------------------: |
| MovieLikeBL  |      负责实现想看电影相关的服务      |
| StatisticsBL | 负责实现获取电影统计数据所需要的服务 |

(3) 模块内部类的接口规范

MovieLikeBL和StatisticsBL的接口规范如表XX~XX所示。

<div>
    <table>
        <caption><strong>表x MovieLikeBL模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">MovieLikeBL.likeMovie</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO likeMovie(int userId, int movieId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>标记电影为想看</td>
        </tr>
        <tr>
            <td rowspan="4">MovieLikeBL.unLikeMovie</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO unlikeMovie(int userId, int movieId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>取消电影为想看</td>
        </tr>
        <tr>
            <td rowspan="4">MovieLikeBL.getCountOfLikes</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getCountOfLikes(int movieId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>统计想看电影的人数</td>
        </tr>
        <tr>
            <td rowspan="4">MovieLikeBL.getLikeNumsGroupByDate</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getLikeNumsGroupByDate(int movieId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获得电影每日的想看人数</td>
        </tr>
    </table>
<div>

<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>MovieLikeDataService.insertOneLike(int movieId,int userId)</td>
            <td>插入一条想看记录</td>
        </tr>
        <tr>
        	<td>MovieLikeDataService.deleteOneLike(int movieId,int userId)</td>
            <td>删除一条想看记录</td>
        </tr>
         <tr>
        	<td>MovieLikeDataService.selectLikeNums(int movieId)</td>
            <td>根据movieId查看电影的想看人数</td>
        </tr>
         <tr>
        	<td>MovieLikeDataService.selectLikeMovie(int movieId,int userId)</td>
            <td>根据movieId和userId查找特定想看记录</td>
        </tr>
         <tr>
        	<td>MovieLikeDataService.selectMovieScheduleTimes(Date date, Date nextDate)</td>
            <td>查询date当天每部电影的排片次数</td>
        </tr>
        <tr>
        	<td>MovieLikeDataService.getDateLikeNum(int movieId)</td>
            <td>根据movieId获取按日期统计的想看人数</td>
        </tr>
    </table>
</div>

<div>
    <table>
        <caption><strong>表x StatisticsBL模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">StatisticsBL.getScheduleRateByDate</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getScheduleRateByDate(Date date)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取某日各影片排片率统计数据</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsBL.getTotalBoxOffice</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getTotalBoxOffice()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取所有电影的累计票房(降序排序，且包含已下架的电影)</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsBL.getAudiencePriceSevenDays</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getAudiencePriceSevenDays()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获得过去7天内每天客单价</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsBL.getMoviePlacingRateByDate</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getMoviePlacingRateByDate(Date date)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取所有电影某天的上座率</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsBL.getPopularMovies</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getPopularMovies(int days, int movieNum)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取最近days天内，票房最高的的movieNum个电影</td>
        </tr>
    </table>
<div>

<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
         <tr>
        	<td>StatisticsDataService.selectMovieScheduleTimes(Date date, Date nextDate)</td>
            <td>查询date当天每部电影的排片次数</td>
        </tr>
        <tr>
        	<td>StatisticsDataService.getDateLikeNum(int movieId)</td>
            <td>根据movieId获取按日期统计的想看人数</td>
        </tr>
        <tr>
        	<td>StatisticsDataService.selectMovieTotalBoxOffice()</td>
            <td>查询所有电影的总票房（包括已经下架的，降序排列）</td>
        </tr>
        <tr>
        	<td>StatisticsDataService.selectAudiencePrice(Date date,Date nextDate)</td>
            <td>查询date当天每个客户的购票金额</td>
        </tr>
        <tr>
        	<td>StatisticsDataService.selectPlacingRate(Date date,Date nextDate)</td>
            <td>查询date当天各电影上座率</td>
        </tr>
        <tr>
        	<td>StatisticsDataService.selectRecentTotalBoxOffice(Date startDate,Date today,int num)</td>
            <td>查询startDate到today日期内票房最高的num部电影</td>
        </tr>
    </table>
</div>

(4) 业务逻辑层的动态模型

图XX~XX是影院管理系统中StatisticsBL进行业务逻辑处理时的顺序图。

![]()

![]()

由于MovieLikeBL和StatisticsBL只作为工具进行业务逻辑处理，不持有成员变量，因而在处理过程中是无状态的。

(5) 业务逻辑层的设计原理

利用SpringBoot的依赖注入，通过数据层接口获得po后，进行业务逻辑处理，将需要在页面上显示的信息封装成vo，最后封装成ResponseVO返回给上层。

#### 4.1.X consumebl模块

(1)模块概述

consumebl模块承担的需求参见需求规格说明文档功能需求及相关非功能需求。

consumebl模块的职责及接口参见软件体系结构文档表Y。

(2) 整体结构

根据体系结构的设计，我们将系统分为展示层、控制层、业务逻辑层、数据层。每一层之间为了增加灵活性，我们会添加接口。比如业务逻辑层和数据层之间，我们添加consumedataservice.ConsumeDataService接口。为了隔离业务逻辑职责和逻辑控制职责，我们增加了控制层的ConsumeController，这样ConsumeController会将电影统计数据相关的逻辑处理委托给ConsumeBL。

consumebl模块的设计如图XX所示。

![]()

<div style="text-align: center">图XX consumebl模块各个类的设计</div>

consumebl模块各个类的职责如表XX所示。

<div style="text-align: center">表XXconsumebl模块各个类的职责</div>

|   模块    |              职责              |
| :-------: | :----------------------------: |
| ConsumeBL | 负责实现充值消费记录相关的服务 |

(3) 模块内部类的接口规范

ConsumeBL的接口规范如表XX所示。

<div>
    <table>
        <caption><strong>表x ConsumeBL模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">ConSumeBL.getAllTopUpHistory</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getAllTopUpHistory(Integer userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取用户全部的充值记录</td>
        </tr>
        <tr>
            <td rowspan="4">ConSumeBL.getBriefConsumeHis</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getBriefConsumeHis(Integer userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取用户简略消费记录信息</td>
        </tr>
        <tr>
            <td rowspan="4">ConSumeBL.getConsumeHisDetail</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getConsumeHisDetail(Integer id)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取用户消费记录详细信息</td>
        </tr>
        <tr>
            <td rowspan="4">ConSumeBL.addTopUpHistory</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO addTopUpHistory(Integer userId, Double money, Double discount, Double balance, Timestamp time)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>添加充值记录</td>
        </tr>
        <tr>
            <td rowspan="4">ConSumeBL.addConsumeHistory</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO addConsumeHistory(Integer userId, Double money, Double discount, String consumeType,Integer type, Integer contentId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>添加消费记录</td>
        </tr>
        <tr>
            <td rowspan="4">ConSumeBL.getConsumeQualifiedUsers</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getConsumeQualifiedUsers(Double totalConsume)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取消费总额满一定值的用户信息</td>
        </tr>
    </table>
<div>
<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>ConsumeDateService.getTopUpHistoryByUserId(Integer userId)</td>
            <td>根据userId获取此用户的充值记录列表，若无记录则返回空</td>
        </tr>
        <tr>
        	<td>ConsumeDateService.getConsumeHistoryByUserId(Integer userId)</td>
            <td>根据userId获取此用户的消费记录列表，若无记录则返回空</td>
        </tr>
         <tr>
        	<td>ConsumeDateService.getConsumeHistoryById(Integer id)</td>
            <td>根据id获取消费记录</td>
        </tr>
         <tr>
        	<td>ConsumeDateService.insertTopUpHistory(Integer userId, Double money,Double discount,Double balance,Timestamp time)</td>
            <td>插入新的充值记录</td>
        </tr>
         <tr>
        	<td>ConsumeDateService.insertConsumeHistory(Integer userId, Double money,Double discount,String consumeType,Integer type,Integer contentId)</td>
            <td>插入新的消费记录</td>
        </tr>
        <tr>
        	<td>ConsumeDateService.selectConsumeQulifiedUsers(Double totalConsume)</td>
            <td>获得消费总额大于totalConsume的用户</td>
        </tr>
        <tr>
        	<td>HallServiceForBl.getHallById(int id)</td>
            <td>获得指定影厅信息</td>
        </tr>
        <tr>
        	<td>MovieServiceForBl.getMovieById(int id)</td>
            <td>获得指定电影信息</td>
        </tr>
        <tr>
        	<td>ScheduleServiceForBl.getScheduleItemById(int id)</td>
            <td>获得指定排片信息</td>
        </tr>
        <tr>
        	<td>VipService.getCardById(int id)</td>
            <td>获得指定会员卡信息</td>
        </tr>
        <tr>
        	<td>TicketServiceForBl.getTicketById(int id)</td>
            <td>获得指定电影票信息</td>
        </tr>
    </table>
</div>

(4) 业务逻辑层的动态模型

图XX~XX是影院管理系统中ConsumeBL进行业务逻辑处理时的顺序图。

![]()

![]()

由于ConsumeBL只作为工具进行业务逻辑处理，不持有成员变量，因而在处理过程中是无状态的。

(5) 业务逻辑层的设计原理

利用SpringBoot的依赖注入，通过数据层接口获得po后，进行业务逻辑处理，将需要在页面上显示的信息封装成vo，最后封装成ResponseVO返回给上层。