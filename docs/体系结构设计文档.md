# 影院管理系统（CMS）体系结构设计文档

## 文档修改历史

| 修改人员 |   日期    |    修改原因    | 版本号 |
| :------: | :-------: | :------------: | :----: |
| Agent_67 | 2019.5.22 |     初始化     |  v0.0  |
| Agent_67 | 2019.5.25 |   第一次整合   |  v1.0  |
| Agent_67 | 2019.6.17 |  添加包设计图  |  v2.0  |
| Agent_67 | 2019.6.19 | 修复描述性错误 |  v2.1  |

## 1.引言

### 1.1 编制目的

本报告详细完成对影院管理系统的概要设计，达到指导详细设计和开发的目的，同时实现和测试人员及用户的沟通。

本报告面向开发人员、测试人员及最终用户编写，是了解系统的导航。

### 1.2 词汇表

| 词汇名称 |   词汇含义   |           备注           |
| :------: | :----------: | :----------------------: |
|   CMS    | 影院管理系统 | Cinema Management System |

### 1.3参考资料

1. IEEE标准。
2. 影院管理系统用例文档。
3. 影院管理系统需求规格说明文档。
4. 骆斌，丁二玉，刘钦 - 软件工程与计算 . 卷二 , 软件开发的技术基础 : Software engineering and computing . Volume Ⅱ , Fundamentals of software development technology。

## 2.产品概述

参考影院管理系统用例文档和需求规格说明文档中对产品的概括描述。

## 3.逻辑视图

影院管理系统中，选择了分层体系结构风格，将系统分为4层（展示层、控制层、业务逻辑层、数据层）能够很好地示意整个高层抽象。展示层包含UI界面，控制层包含UI界面的跳转和业务的访问，业务逻辑层包含业务逻辑处理的实现，数据层负责数据的持久化和访问。分层体系结构的逻辑视角和逻辑设计方案如图1和图2所示。

<img src="https://s2.ax1x.com/2019/04/20/ECBrQJ.png" width="400px"/>

<div style="text-align: center">图1 参照体系风格结构的包图表达逻辑</div>

![](https://s2.ax1x.com/2019/06/17/VbedEj.png)

<div style="text-align: center">图2 软件体系结构逻辑设计方案</div>

## 4.组合视图

### 4.1 开发包图

影院管理系统的第三阶段开发包设计如表1所示。

<div style="text-align: center">表1 影院管理系统的第三阶段开发包设计</div>

|    开发（物理）包    |                       依赖的其他开发包                       |
| :------------------: | :----------------------------------------------------------: |
|     interceptor      | usercon,hallcon,ticketcon,cardcon,<br/>activitycon,consumecon,couponcon,statisticscon |
|       viewcon        |                                                              |
|        userui        |                          usercon,vo                          |
|       usercon        |                       userblservice,vo                       |
|    userblservice     |                                                              |
|        userbl        |                    userdataservice,po,vo                     |
|   userdataservice    |                              po                              |
|       userdata       |                          mybatis,po                          |
|       hallui       |                         hallcon,vo                         |
|       hallcon       |                      hallblservice,vo                      |
|    hallblservice    |                                                              |
|       hallbl       |                    halldataservice,po,vo                    |
|   halldataservice   |                              po                              |
|      halldata      |                          mybatis,po                          |
|      ticketui      |                        ticketcon,vo                        |
|     ticketcon      |                     ticketblservice,vo                     |
|  ticketblservice   |                                                              |
|      ticketbl      |                  ticketdataservice,po,vo                   |
| ticketdataservice |                              po                              |
|     ticketdata     |                          mybatis,po                          |
|       cardui       |                         cardcon,vo                         |
|      cardcon       |                      cardservice,vo                      |
|   cardblservice    |                                                              |
|       cardbl       |                   carddataservice,po,vo                    |
|  carddataservice   |                              po                              |
|      carddata      |                          mybatis,po                          |
|      couponcon       |                      couponservice,vo                      |
|   couponblservice    |                                                              |
|       couponbl       |                   coupondataservice,po,vo                    |
|  coupondataservice   |                              po                              |
|      coupondata      |                          mybatis,po                          |
|     activityui      |                       activitycon,vo                        |
|     activitycon     |                    activityblservice,vo                     |
|  activityblservice  |                                                              |
|     activitybl      |                  activitydataservice,po,vo                  |
| activitydataservice |                              po                              |
|    activitydata     |                          mybatis,po                          |
|     statisticsui     |                       statisticscon,vo                       |
|     statisticscon    |                    statisticsblservice,vo                    |
|     statisticsbl     |                                                              |
|  statisticsblservice |                 statisticsdataservice,po,vo                  |
| statisticsdataservice|                              po                              |
|    statisticsdata    |                          mybatis,po                          |
|       consumeui      |                        consumecon,vo                         |
|      consumecon      |                     consumeblservice,vo                      |
|   consumeblservice   |                                                              |
|       consumebl      |                   consumedataservice,po,vo                   |
|  consumedataservice  |                              po                              |
|      consumedata     |                          mybatis,po                          |
|          vo          |                                                              |
|          po          |                                                              |
|       mybatis        |                                                              |

影院管理系统客户端开发包图如图3所示，服务器端开发包图如图4所示。

![](https://s2.ax1x.com/2019/06/17/VbecKU.png)

<div style="text-align: center">图3 影院管理系统客户端开发包图</div>

![](https://s2.ax1x.com/2019/06/17/VbZvcT.png)

<div style="text-align: center">图4 影院管理系统服务器端开发包图</div>

### 4.2 运行时进程

在影院管理系统中，会有一个服务器进程，其进程如图5所示。结合部署图，客户端是客户端机器上的浏览器，服务端进程是在服务端机器上运行。

![](https://s2.ax1x.com/2019/04/20/ECDSyj.png)

<div style="text-align: center">图5 进程图</div>

### 4.3 物理部署

影院管理系统中服务器端构件是放在服务器端机器上，客户端通过HTTP协议与服务器进行交互，不需要在独立部署。部署图如图6所示。

![](https://s2.ax1x.com/2019/04/20/ECDKmR.png)

<div style="text-align: center">图6 部署图</div>

## 5.架构设计

### 5.1 模块职责

服务器端模块视图如图7所示。服务器端各层的职责如表2所示。

![](https://s2.ax1x.com/2019/04/20/ECD3tK.png)

<div style="text-align: center">图7 服务器端模块视图</div>

<div style="text-align: center">表2 服务器端各层的职责</div>

|     层     |              职责               |
| :--------: | :-----------------------------: |
|   展示层   | 显示在客户端浏览器中的用户界面  |
|   控制层   | 基于用户请求的URL调用相应的服务 |
| 业务逻辑层 |        进行业务逻辑处理         |
|   数据层   |   数据的持久化及数据访问接口    |
|  启动模块  |   负责启动SpringBoot项目进程    |

每一层只是使用下方直接接触的层。除了展示层与控制层之间通过URL进行调用，层与层之间仅仅是通过接口的调用来完成的。层之间调用的接口如表3所示。

<style>
	table td {
    	vertical-align: middle
	}
</style>
<div>
    <table style="text-align: center">
        <caption>表3 层之间调用的接口<caption>
        <hr>
        <tbody>
            <tr rowspan="1">
                <td rowspan="1"><strong>接口</strong></td>
                <td rowspan="1"><strong>服务调用方</strong></td>
                <td rowspan="1"><strong>服务提供方</strong></td>
            </tr>
        </tbody>
        <tbody>
            <tr rowspan="6">
                <td rowspan="6">UserBLService<br/>HallBLService<br/>SalesBLService<br/>CardBLService<br/>CouponBLService<br/>ActivityBLService<br/>StatisticsBLSerivce<br/>ConsumeBLService</td>
            </tr>
            <tr rowspan="6">
                <td rowspan="6">控制层</td>
            </tr>
            <tr rowspan="6">
                <td rowspan="6">业务逻辑层</td>
            </tr>
        </tbody>
        <tbody>
            <tr rowspan="6">
                <td rowspan="6">UserDataService<br/>HallDataService<br/>SalesDataServie<br/>CardBLService<br/>CouponBLService<br/>ActivityDataService<br/>StatisticsDataService<br/>ConsumeDataService</td>
            </tr>
            <tr rowspan="6">
                <td rowspan="6">业务逻辑层</td>
            </tr>
            <tr rowspan="6">
                <td rowspan="6">数据层</td>
            </tr>
        </tbody>
    </table>
</div>	


借用User模块来说明层之间的调用，如图8所示。控制层、业务逻辑层、数据层之间都由上层依赖了一个接口（需接口），而下层实现这个接口（供接口）。UserBLService提供了UserController所要调用的服务。UserDataService提供了对数据库的增、查等操作。这样的实现就大大降低了层与层之间的耦合。

![](https://s2.ax1x.com/2019/04/20/EC6pCV.png)

<div style="text-align: center">图8 User模块层之间调用的接口</div>

### 5.2 用户界面层分解

根据需求，系统存在21个用户界面，界面跳转如图9所示。

![](https://i.loli.net/2019/06/17/5d077ac36100595646.jpg)

<div style="text-align: center">图9 用户界面跳转</div>

服务器端和客户端的用户界面实际上是一样的，通过HTTP协议进行传输。用户界面层的设计如图10所示。

![](https://i.loli.net/2019/06/17/5d0782e41b55392519.jpg)

<div style="text-align: center">图10 用户界面层设计</div>

#### 5.2.1 职责

用户界面层模块的职责如表4所示。

<div>
    <table>
        <caption>表4 用户界面层模块的职责<caption>
        <hr>
        <tr>
        	<td><strong>模块</strong></td>
            <td><strong>职责</strong></td>
        </tr>
        <tr>
        	<td>HallUI</td>
            <td>负责影厅信息增、删、改、查功能的界面和发送请求</td>
        </tr>
        <tr>
        	<td>UserUI</td>
            <td>负责登录、注册、观众主界面、管理员主界面、影院角色管理的显示和发送请求</td>
        </tr>
        <tr>
        	<td>SalesUI</td>
            <td>负责购票、退票界面，管理退票界面的现实和发送请求</td>
        </tr>
        <tr>
            <td>StatisticsUI</td>
            <td>负责想看电影标记，电影统计数据界面的显示和发送请求</td>
        </tr>
        <tr>
            <td>ConsumeUI</td>
            <td>负责充值记录，消费记录，消费详情界面的显示和发送请求</td>
        </tr>
        <tr>
            <td>ActivityUI</td>
            <td>负责发布优惠活动界面的显示和发送请求</td>
        </tr>
        <tr>
            <td>CardUI</td>
            <td>负责发布会员卡、购买会员卡、充值会员卡界面的显示和发送请求</td>
        </tr>
        <tr>
            <td>CouponUI</td>
            <td>负责赠送优惠券的显示和发送请求</td>
        </tr>
    </table>
</div>


#### 5.2.2 接口规范

第三阶段用户界面层的接口规范如表5~12所示。

<div>
    <table>
        <caption><strong>表5 hallui模块接口规范</strong><caption>
        <hr/>
        <caption><strong>需要的服务（需接口）</strong><caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>HallController.AddHall</td>
            <td>添加影厅信息</td>
        </tr>
        <tr>
            <td>HallController.UpdateHall</td>
            <td>更新影厅信息</td>
        </tr>
        <tr>
            <td>HallController.RemoveHall</td>
            <td>删除影厅信息</td>
        </tr>
        <tr>
            <td>HallController.getAvailableHalls</td>
            <td>获取所有空闲的影厅信息列表</td>
        </tr>
        <tr>
            <td>HallController.searchAllHall</td>
            <td>获取所有的影厅信息列表</td>
        </tr>
    </table>
</div>

<div>
    <table>
        <caption><strong>表6 userui模块接口规范</strong><caption>
        <hr/>
        <caption><strong>需要的服务（需接口）</strong><caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>UserController.login(UserForm userForm, HttpSession session)</td>
            <td>登录系统，建立会话</td>
        </tr>
        <tr>
            <td>UserController.registerAccount(UserForm userForm)</td>
            <td>注册系统账号</td>
        </tr>
        <tr>
            <td>UserController.logOut(HttpSession session)</td>
            <td>退出登录，结束回话</td>
        </tr>
        <tr>
            <td>UserController.checkPassword(String rawPassword, HttpSession session)</td>
            <td>验证账号密码</td>
        </tr>
        <tr>
            <td>UserController.editPassword(UserForm userForm)</td>
            <td>修改账号密码</td>
        </tr>
        <tr>
            <td>UserController.getAdaptableRoles(Integer level)</td>
            <td>获取当前身份等级可修改的影院角色</td>
        </tr>
        <tr>
            <td>UserController.deleteRole(Integer id)</td>
            <td>删除影院角色</td>
        </tr>
        <tr>
            <td>UserController.editRole(RoleVO form)</td>
            <td>修改影院角色信息</td>
        </tr>
        <tr>
            <td>UserController.addRole(RoleVO form)</td>
            <td>修改影院角色</td>
        </tr>
    </table>
</div>

<div>
    <table>
        <caption><strong>表7 salesui模块接口规范</strong><caption>
        <hr/>
        <caption><strong>需要的服务（需接口）</strong><caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>SalesController.buyTicketByVIPCard(TicketAndCouponVO ticketAndCouponVO)</td>
            <td>使用会员卡购票</td>
        </tr>
        <tr>
            <td>SalesController.lockSeat(TicketForm ticketForm)</td>
            <td>未付款时提供锁座服务</td>
        </tr>
        <tr>
            <td>SalesController.buyTicket(TicketAndCouponVO ticketAndCouponVO)</td>
            <td>购票</td>
        </tr>
        <tr>
            <td>SalesController.getTicketByUserId(int userId)</td>
            <td>通过用户id获取用户买过的电影票</td>
        </tr>
        <tr>
            <td>SalesController.getOccupiedSeats(int scheduleId)</td>
            <td>通过排片id获取被锁座位</td>
        </tr>
        <tr>
            <td>SalesController.getTicketByUserId(int userId)deleteTicket(int ticketId)</td>
            <td>删除电影票</td>
        </tr>
        <tr>
            <td>SalesController.cancelTicket(List<Integer> ticketId)</td>
            <td>取消锁座</td>
        </tr>
        <tr>
            <td>SalesController.issueTicket(int ticketId)</td>
            <td>出票</td>
        </tr>
        <tr>
            <td>SalesController.getAllRefund()</td>
            <td>获取所有退票策略</td>
        </tr>
        <tr>
            <td>SalesController.publishRefund(RefundForm refundForm)</td>
            <td>新增退票策略</td>
        </tr>
        <tr>
            <td>SalesController.getRefundById(int refundId)</td>
            <td>获取退票策略</td>
        </tr>
        <tr>
            <td>SalesController.deleteRefund(int refundId)</td>
            <td>删除退票策略</td>
        </tr>
    </table>
</div>
<div>
    <table>
        <caption><strong>表8 statisticsui模块接口规范</strong><caption>
        <hr/>
        <caption><strong>需要的服务（需接口）</strong><caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>StatisticsController.likeMovie(int userId, int movieId)</td>
            <td>标记电影为想看</td>
        </tr>
        <tr>
            <td>StatisticsController.unlikeMovie(int userId, int movieId)</td>
            <td>取消电影为想看</td>
        </tr>
        <tr>
            <td>StatisticsController.getCountOfLikes(int movieId)</td>
            <td>统计电影想看人数</td>
        </tr>
        <tr>
            <td>StatisticsController.getLikeNumsGroupByDate(int movieId)</td>
            <td>获得按日期统计的电影想看人数</td>
        </tr>
        <tr>
            <td>StatisticsController.getScheduleRateByDate(Date date)</td>
            <td>获得指定日期的排片率</td>
        </tr>
        <tr>
            <td>StatisticsController.getTotalBoxOffice()</td>
            <td>获得全部电影总票房</td>
        </tr>
        <tr>
            <td>StatisticsController.getAudiencePriceSevenDays()</td>
            <td>获得过去7天内每天客单价</td>
        </tr>
        <tr>
            <td>StatisticsController.getMoviePlacingRateByDate(Date date)</td>
            <td>获取所有电影某天的上座率</td>
        </tr>
        <tr>
            <td>StatisticsController.getPopularMovies(int days, int movieNum)</td>
            <td>获取最近days天内，票房最高的的movieNum个电影</td>
        </tr>
    </table>
</div>

<div>
    <table>
        <caption><strong>表9 consumeui模块接口规范</strong><caption>
        <hr/>
        <caption><strong>需要的服务（需接口）</strong><caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>ConsumeController.getAllTopUpHistory(Integer userId)</td>
            <td>获取用户全部的充值记录</td>
        </tr>
        <tr>
            <td>ConsumeController.getBriefConsumeHis(Integer userId)</td>
            <td>获取用户简略消费记录信息</td>
        </tr>
        <tr>
            <td>ConsumeController.getConsumeHisDetail(Integer id)</td>
            <td>获取用户消费记录详细信息</td>
        </tr>
        <tr>
            <td>ConsumeController.addTopUpHistory(Integer userId, Double money, Double discount, Double balance, Timestamp time)</td>
            <td>添加充值记录</td>
        </tr>
        <tr>
            <td>ConsumeController.addConsumeHistory(Integer userId, Double money, Double discount, String consumeType,Integer type, Integer contentId)</td>
            <td>添加消费记录</td>
        </tr>
        <tr>
            <td>ConsumeController.getConsumeQualifiedUsers(Double totalConsume)</td>
            <td>获取消费总额满一定值的用户信息</td>
        </tr>
    </table>
</div>

<div>
    <table>
        <caption><strong>表10 activityui模块接口规范</strong><caption>
        <hr/>
        <caption><strong>需要的服务（需接口）</strong><caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>ActivityController.publishActivity(ActivityForm activityForm)</td>
            <td>发布一个优惠活动</td>
        </tr>
        <tr>
            <td>ActivityController.getActivities()</td>
            <td>获取所有优惠活动信息</td>
        </tr>
        <tr>
            <td>ActivityController.deleteActivity(int activityId)</td>
            <td>删除优惠活动</td>
        </tr>
        <tr>
            <td>ActivityController.getActivityById(int activityId)</td>
            <td>获取指定id的优惠活动</td>
        </tr>
    </table>
</div>

<div>
    <table>
        <caption><strong>表11 cardui模块接口规范</strong><caption>
        <hr/>
        <caption><strong>需要的服务（需接口）</strong><caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>CardTypeController.getCards()</td>
            <td>获取所有会员卡的类型</td>
        </tr>
        <tr>
            <td>CardTypeController.publishCard(CardTypeForm cardTypeForm)</td>
            <td>发布新的会员卡的类型</td>
        </tr>
        <tr>
            <td>CardTypeController.deleteCard(int cardId)</td>
            <td>删除某种会员卡类型</td>
        </tr>
        <tr>
            <td>CardTypeController.updateCard(int cardId,CardTypeForm cardTypeForm)</td>
            <td>更新某种会员卡类型的信息</td>
        </tr>
        <tr>
            <td>VIPCardController.addVIP(int userId,int cardTypeId)</td>
            <td>为指定用户增加会员卡</td>
        </tr>
        <tr>
            <td>VIPCardController.getVIP(int userId)</td>
            <td>获取某用户的有效会员卡</td>
        </tr>
        <tr>
            <td>VIPCardController.charge(VIPCardForm vipCardForm)</td>
            <td>为指定会员卡充值制定金额</td>
        </tr>
        <tr>
            <td>VIPCardController.changeVIP(int cardId,int cardTypeId)</td>
            <td>更换指定用户的会员卡类型</td>
        </tr>
    </table>
</div>

<div>
    <table>
        <caption><strong>表12 couponui模块接口规范</strong><caption>
        <hr/>
        <caption><strong>需要的服务（需接口）</strong><caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>CouponController.getAllCoupons()</td>
            <td>获取所有优惠券</td>
        </tr>
        <tr>
            <td>CouponController.getUsersByConsume(double totalConsume)</td>
            <td>获取满足一定消费总额的用户</td>
        </tr>
        <tr>
            <td>CouponController.presentCoupon2User(PresentForm presentForm)</td>
            <td>批量赠送优惠券</td>
        </tr>
    </table>
</div>


#### 5.2.3 用户界面层设计原理

用户界面层利用HTML+CSS+JavaScript来实现。

### 5.3 控制层分解

控制层包括多个针对用户界面层模块的控制模块。例如，usercon负责处理userui模块下界面的请求；moviecon负责处理movieui模块下界面的请求。控制层的设计如图11所示。

![](https://s2.ax1x.com/2019/06/17/VbQ9HO.png)

<div style="text-align: center">图11 控制层设计</div>

#### 5.3.1 职责

控制层模块的职责如表13所示。

<div>
    <table>
        <caption>表13 控制层模块的职责<caption>
        <hr>
        <tr>
        	<td><strong>模块</strong></td>
            <td><strong>职责</strong></td>
        </tr>
        <tr>
        	<td>HallController</td>
            <td>负责实现与影厅信息增删改查相关的控制逻辑</td>
        </tr>
        <tr>
        	<td>UserController</td>
            <td>负责实现与用户账户相关的控制逻辑</td>
        </tr>
        <tr>
        	<td>SalesController</td>
            <td>负责实现与购票相关的控制逻辑</td>
        </tr>
        <tr>
            <td>StatisticsController</td>
            <td>负责实现与电影统计数据相关的控制逻辑</td>
        </tr>
        <tr>
            <td>ConsumeController</td>
            <td>负责实现与充值消费记录相关的控制逻辑</td>
        </tr>
        <tr>
            <td>ActivityController</td>
            <td>负责实现与优惠活动相关的控制逻辑</td>
        </tr>
        <tr>
            <td>CardController</td>
            <td>负责实现与会员卡相关的控制逻辑</td>
        </tr>
        <tr>
            <td>CouponController</td>
            <td>负责实现与优惠券相关的控制逻辑</td>
        </tr>
    </table>
</div>

#### 5.3.2 接口规范

控制层的接口规范如表14~表21所示。

<div>
    <table>
        <caption><strong>表14 hallcon模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">HallController.searchAllHall</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO searchAllHall()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>GET /hall/all</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>返回所有影厅信息列表</td>
        </tr>
        <tr>
            <td rowspan="4">HallController.addHall</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO addHall(HallVO hallVO)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>POST /hall/add ，hallVO不为空且符合输入规则</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据hallVO查询是否已经存在相同的hallName，如果没有则新增一条影厅信息记录，最后返回增加影厅信息的结果</td>
        </tr>
        <tr>
            <td rowspan="4">HallController.updateHall</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO updateHall(HallVO hallVO)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>POST /hall/update ，hallVO不为空且符合输入规则</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据hallVO查询是否已经存在相同的hallName，如果没有则将原来对应的影厅信息更新，最后返回更新影厅信息的结果</td>
        </tr>
        <tr>
            <td rowspan="4">HallController.removeHall</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO removeHall(int hallId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>POST /hall/remove 或者 GET /hall/remove</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据hallId查询是否存在对应的影厅信息记录，如果有则将对应的影厅信息删除，最后返回删除影厅信息的结果</td>
        </tr>
        <tr>
            <td rowspan="4">HallController.getAvailableHalls</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getAvailableHalls()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>POST /hall/available 或者 GET /hall/available</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>返回所有空闲的影厅信息列表</td>
        </tr>
    </table>
<div>
<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>HallBLService.searchAllHall</td>
            <td>获取所有影厅信息列表</td>
        </tr>
        <tr>
            <td>HallBLService.addHall</td>
            <td>添加影厅信息</td>
        </tr>
        <tr>
            <td>HallBLService.updateHall</td>
            <td>更新影厅信息</td>
        </tr>
        <tr>
            <td>HallBLService.removeHall</td>
            <td>删除影厅信息</td>
        </tr>
        <tr>
            <td>HallBLService.getAvailableHalls</td>
            <td>获取所有空闲（没有排片）的影厅信息列表</td>
        </tr>
    </table>
</div>

<div>
    <table>
        <caption><strong>表15 usercon模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4"> UserController.login </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public User login(UserForm userForm, HttpSession session)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/login")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据username查找是否存在相应的User，如果username和password相匹配，则建立session会话，最后返回登录验证的结果</td>
        </tr>
        <tr>
            <td rowspan="4"> UserController.registerAccount </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO registerAccount(UserForm userForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/register")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据UserForm查找是否已经存在对应的username，如果没有，则增加一条新的用户账号记录，最后返回注册的结果</td>
        </tr>
        <tr>
            <td rowspan="4"> UserController.logout </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO logOut(HttpSession session)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/logout")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>如果sessionId是有效的，则在session中删除sessionId对应的session记录，最后返回退出登录结果</td>
        </tr>
        <tr>
            <td rowspan="4"> UserController.checkPassword </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO checkPassword(String rawPassword, HttpSession session)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/user/checkPassword")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据用户输入的密码返回验证结果</td>
        </tr>
        <tr>
            <td rowspan="4"> UserController.editPassword </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO editPassword(UserForm userForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/user/edit/password")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据userForm查找用户的账号并修改账号密码，返回修改的结果</td>
        </tr>
        <tr>
            <td rowspan="4"> UserController.getAdaptableRoles </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getAdaptableRoles(Integer level)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/role/get")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>如果等级是有效的，根据等级查找并返回该等级可修改的影院角色</td>
        </tr>
        <tr>
            <td rowspan="4"> UserController.deleteRole </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO deleteRole(Integer id)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/role/delete")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>如果该id是有效的，根据id查找并删除该影院角色，返回删除结果</td>
        </tr>
        <tr>
            <td rowspan="4"> UserController.editRole </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO editRole(RoleVO form)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/role/edit")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>修改影院角色并返回修改结果</td>
        </tr>
        <tr>
            <td rowspan="4"> UserController.addRole </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO addRole(RoleVO form)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/role/add")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据from添加影院角色，并返回添加结果</td>
        </tr>
    </table>
<div>
<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>UserBLService.registerAccount(UserForm userForm)</td>
            <td>注册账号</td>
        </tr>
        <tr>
            <td>UserBLService.login(UserForm userForm)</td>
            <td>用户登录，登录成功会将用户信息保存在session中</td>
        </tr>
        <tr>
            <td>UserBLService.checkPassword(User user, String rawPassword)</td>
            <td>检测密码是否正确</td>
        </tr>
        <tr>
            <td>UserBLService.editPassword(UserForm userForm)</td>
            <td>修改密码</td>
        </tr>
        <tr>
            <td>UserBLService.getAdaptableRoles(Integer level)</td>
            <td>获取当前身份等级可修改的影院角色(同级或更高级只可见用户名)</td>
        </tr>
        <tr>
            <td>UserBLService.deleteRole(Integer id)</td>
            <td>删除影院角色</td>
        </tr>
        <tr>
            <td>UserBLService.editRole(RoleVO form)</td>
            <td>修改角色信息</td>
        </tr>
        <tr>
            <td>UserBLService.addRole(RoleVO form)</td>
            <td>添加影院角色</td>
        </tr>
    </table>
</div>



<div>
    <table>
        <caption><strong>表16 salescon模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4"> SalesController.buyTicketByVIPCard </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO buyTicketByVIPCard(TicketAndCouponVO ticketAndCouponVO)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/ticket/vip/buy")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据ticket查找是否存在相应的会员卡，根据couponId查找是否存在相应的优惠券，存在则完成购买电影票流程，返回购买结果</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesController.lockSeat </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO lockSeat(TicketForm ticketForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/ticket/lockSeat")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据ticketFrom锁座，返回锁座结果</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesController.buyTicket </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO buyTicket(TicketAndCouponVO ticketAndCouponVO)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/ticket/buy")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据ticketAndCouponVO查找并购买电影票，并返回购票结果</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesController.getTicketByUserId </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getTicketByUserId(int userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td> @GetMapping("/ticket/get/{userId}")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据userId查找并返回用户买过的电影票</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesController.getOccupiedSeats </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getOccupiedSeats(int scheduleId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/ticket/get/occupiedSeats")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据scheduleId查找并返回该排片的锁座情况</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesController.cancelTicket </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO cancelTicket(List<Integer> ticketId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/ticket/cancel")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据ticketId查找并删除电影票，返回删除结果</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesController.deleteTicket </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO deleteTicket(int ticketId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/ticket/delete")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据ticketId查找并退还电影票，返回退票结果</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesController.issueTicket </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO issueTicket(int ticketId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/ticket/issue")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据ticketId查找并修改电影票状态为出票，返回出票结果</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesController.getAllRefund </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getAllRefund()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/refund/all")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取并返回所有退票策略</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesController.publishRefund </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO publishRefund(RefundForm refundForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/refund/add")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据refundFrom新增一条退票策略，返回新增结果</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesController.deleteRefund </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO deleteRefund(int refundId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/refund/delete")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据refundId查找并删除退票策略，返回删除结果</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesController.getRefundById </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getRefundById(int refundId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/refund/get")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据refundId查找并返回退票策略</td>
        </tr>
    </table>
<div>
<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>SalesBLService.addTicket(TicketForm ticketForm)</td>
            <td>锁座，添加票并将状态设为未付款</td>
        </tr>
        <tr>
            <td>SalesBLService.completeTicket(List<Integer> id, int couponId)</td>
            <td>完成购票</td>
        </tr>
        <tr>
            <td>SalesBLService.getBySchedule(int scheduleId)</td>
            <td>获得该场次的被锁座位和场次信息</td>
        </tr>
        <tr>
            <td>SalesBLService.getTicketByUser(int userId)</td>
            <td>获得用户买过的票</td>
        </tr>
        <tr>
            <td>SalesBLService.completeByVIPCard(List<Integer> id, int couponId)</td>
            <td>使用会员卡完成购票</td>
        </tr>
        <tr>
            <td>SalesBLService.cancelTicket(List<Integer> id)</td>
            <td>取消锁座</td>
        </tr>
        <tr>
            <td>SalesBLService.issueTicket(int id)</td>
            <td>出票，将票的状态改为已出票</td>
        </tr>
        <tr>
            <td>SalesBLService.getAllRefund()</td>
            <td>获取所有退票策略</td>
        </tr>
        <tr>
            <td>SalesBLService.publishRefund(RefundForm refundForm)</td>
            <td>添加一个退票策略</td>
        </tr>
        <tr>
            <td>SalesBLService.deleteRefund(int refundId)</td>
            <td>删除退票策略</td>
        </tr>
        <tr>
            <td>SalesBLService.getRefundById(int refundId)</td>
            <td>根据id获得退票策略</td>
        </tr>
    </table>
</div>

<div>
    <table>
        <caption><strong>表17 statisticscon模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">StatisticsController.likeMovie</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO likeMovie(int movieId,int userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/movie/{movieId}/like")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>标记电影为想看</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsController.unlikeMovie</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO unlikeMovie(int movieId,int userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/movie/{movieId}/unlike")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>取消电影为想看</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsController.getMovieLikeCounts</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getMovieLikeCounts(int movieId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/movie/{movieId}/like/count")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取电影的想看人数(int)</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsController.getMovieLikeCountByDate</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getMovieLikeCountByDate(int movieId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/movie/{movieId}/like/date")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取电影按日期统计的想看人数(DateLike)</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsController.getScheduleRateByDate</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getScheduleRateByDate(Date date)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/statistics/scheduleRate")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取当日的排片率(MovieScheduleTimeVO)</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsController.getTotalBoxOffice</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getTotalBoxOffice()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/statistics/boxOffice/total")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取全部电影总票房</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsController.getAudiencePrice</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getAudiencePrice()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/statistics/audience/price")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取客单价</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsController.getMoviePlacingRateByDate</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getMoviePlacingRateByDate(Date date)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/statistics/PlacingRate")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取指定日期全部电影的上座率</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsController.getPopularMovies</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getPopularMovies(int days,int movieNum)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/statistics/popular/movie")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取指定天数内票房最高的movieNum部电影</td>
        </tr>
    </table>
<div>




<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>StatisticsBLService.likeMovie(int userId, int movieId)</td>
            <td>标记电影为想看</td>
        </tr>
        <tr>
            <td>StatisticsBLService.unlikeMovie(int userId, int movieId)</td>
            <td>取消电影为想看</td>
        </tr>
        <tr>
            <td>StatisticsBLService.getCountOfLikes(int movieId)</td>
            <td>统计电影想看人数</td>
        </tr>
        <tr>
            <td>StatisticsBLService.getLikeNumsGroupByDate(int movieId)</td>
            <td>获得按日期统计的电影想看人数</td>
        </tr>
        <tr>
            <td>StatisticsBLService.getScheduleRateByDate(Date date)</td>
            <td>获得指定日期的排片率</td>
        </tr>
        <tr>
            <td>StatisticsBLService.getTotalBoxOffice()</td>
            <td>获得全部电影总票房</td>
        </tr>
        <tr>
            <td>StatisticsBLService.getAudiencePriceSevenDays()</td>
            <td>获得过去7天内每天客单价</td>
        </tr>
        <tr>
            <td>StatisticsBLService.getMoviePlacingRateByDate(Date date)</td>
            <td>获取所有电影某天的上座率</td>
        </tr>
        <tr>
            <td>StatisticsBLService.getPopularMovies(int days, int movieNum)</td>
            <td>获取最近days天内，票房最高的的movieNum个电影</td>
        </tr>
    </table>
</div>


<div>
    <table>
        <caption><strong>表18 consumecon模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">ConsumeController.getAllTopupHistory</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getAllTopupHistory(Integer userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/history/topup/get")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取指定用户的充值记录</td>
        </tr>
        <tr>
            <td rowspan="4">ConsumeController.getAllConsumeHistory</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getAllConsumeHistory(Integer userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/history/consume/get")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取指定用户的消费记录</td>
        </tr>
        <tr>
            <td rowspan="4">ConsumeController.getConsumeHisDetail</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getConsumeHisDetail(Integer id)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/history/consume/get/detail")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取消费记录详细信息</td>
        </tr>
    </table>
<div>


<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>ConsumeBLService.getAllTopUpHistory(Integer userId)</td>
            <td>获取用户全部的充值记录</td>
        </tr>
        <tr>
            <td>ConsumeBLService.getBriefConsumeHis(Integer userId)</td>
            <td>获取用户简略消费记录信息</td>
        </tr>
        <tr>
            <td>ConsumeBLSerivce.getConsumeHisDetail(Integer id)</td>
            <td>获取用户消费记录详细信息</td>
        </tr>
        <tr>
            <td>ConsumeBLSerivce.addTopUpHistory(Integer userId, Double money, Double discount, Double balance, Timestamp time)</td>
            <td>添加充值记录</td>
        </tr>
        <tr>
            <td>ConsumeBLSerivce.addConsumeHistory(Integer userId, Double money, Double discount, String consumeType,Integer type, Integer contentId)</td>
            <td>添加消费记录</td>
        </tr>
        <tr>
            <td>ConsumeBLSerivce.getConsumeQualifiedUsers(Double totalConsume)</td>
            <td>获取消费总额满一定值的用户信息</td>
        </tr>
    </table>
</div>
<div>
    <table>
        <caption><strong>表19 activitycon模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">ActivityController.publishActivity</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO publishActivity(ActivityForm activityForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/publish")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>发布一个优惠活动</td>
        </tr>
        <tr>
            <td rowspan="4">ActivityController.getActivities</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getActivities()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/getAll")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取所有优惠活动信息</td>
        </tr>
        <tr>
            <td rowspan="4">ActivityController.deleteActivity</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO deleteActivity(int activityId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/delete")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>删除优惠活动</td>
        </tr>
        <tr>
            <td rowspan="4">ActivityController.getActivityById</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getActivityById(int activityId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/get")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取指定id的优惠活动</td>
        </tr>
    </table>
<div>


<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>ActivityBLService.publishActivity(ActivityForm activityForm)</td>
            <td>发布一个优惠活动</td>
        </tr>
        <tr>
            <td>ActivityBLService.getActivities()</td>
            <td>获取所有优惠活动信息</td>
        </tr>
        <tr>
            <td>ActivityBLService.deleteActivity(int activityId)</td>
            <td>删除优惠活动</td>
        </tr>
        <tr>
            <td>ActivityBLService.getActivityById(int activityId)</td>
            <td>获取指定id的优惠活动</td>
        </tr>
    </table>
</div>


<div>
    <table>
        <caption><strong>表20 cardcon模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">CardTypeController.getCards</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getCards()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/get")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取所有会员卡的类型</td>
        </tr>
        <tr>
            <td rowspan="4">CardTypeController.publishCard</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO publishCard(CardTypeForm cardTypeForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/publish")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>发布新的会员卡的类型</td>
        </tr>
        <tr>
            <td rowspan="4">CardTypeController.deleteCard</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO deleteCard(int cardId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/delete/{cardId}")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>删除某种会员卡类型</td>
        </tr>
        <tr>
            <td rowspan="4">CardTypeController.updateCard</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO updateCard(int cardId,CardTypeForm cardTypeForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/update/{cardId}")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>更新某种会员卡类型的信息</td>
        </tr>
        <tr>
            <td rowspan="4">VIPCardController.addVIP</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO addVIP(int userId,int cardTypeId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/add/{userId}/{cardTypeId}")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>为指定用户增加会员卡</td>
        </tr>
        <tr>
            <td rowspan="4">VIPCardController.getVIP</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getVIP(int userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("/get/{userId}")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取某用户的有效会员卡</td>
        </tr>
        <tr>
            <td rowspan="4">VIPCardController.charge</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO charge(VIPCardForm vipCardForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/charge")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>为指定会员卡充值制定金额</td>
        </tr>
        <tr>
            <td rowspan="4">VIPCardController.changeVIP</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO changeVIP(int cardId,int cardTypeId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("/change/{cardId}/{cardTypeId}")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>更换指定用户的会员卡类型</td>
        </tr>
    </table>
<div>


<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>CardTypeBLService.getCards()</td>
            <td>获取所有会员卡类型</td>
        </tr>
        <tr>
            <td>CardTypeBLService.publishCard(CardTypeForm cardTypeForm)</td>
            <td>发布会员卡类型</td>
        </tr>
        <tr>
            <td>CardTypeBLService.deleteCard(int cardId)</td>
            <td>删除会员卡类型</td>
        </tr>
        <tr>
            <td>CardTypeBLService.updateCard(int cardId, CardTypeForm cardTypeForm)</td>
            <td>更新会员卡类型信息</td>
        </tr>
        <tr>
            <td>VIPCardBLService.addVIPCard(int userId, int cardTypeId)</td>
            <td>为指定用户增加会员卡</td>
        </tr>
        <tr>
            <td>VIPCardBLService.getCardByUserId(int userId)</td>
            <td>获取某用户的有效会员卡</td>
        </tr>
        <tr>
            <td>VIPCardBLService.charge(VIPCardForm vipCardForm)</td>
            <td>为指定会员卡充值制定金额</td>
        </tr>
        <tr>
            <td>VIPCardBLService.changeVIPCard(int cardId, int cardTypeId)</td>
            <td>更换指定用户的会员卡类型</td>
        </tr>
    </table>
</div>


<div>
    <table>
        <caption><strong>表21 couponcon模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">CouponController.getAllCoupons</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getAllCoupons()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("get/coupons")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取所有优惠券</td>
        </tr>
        <tr>
            <td rowspan="4">CouponController.getUsersByConsume</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getUsersByConsume(double totalConsume)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@GetMapping("get/users")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取满足一定消费总额的用户</td>
        </tr>
        <tr>
            <td rowspan="4">CouponController.presentCoupon2User</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO presentCoupon2User(PresentForm presentForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>@PostMapping("present")</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>批量赠送优惠券</td>
        </tr>
    </table>
<div>


<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>CouponBLService.getAllCoupons()</td>
            <td>获取所有优惠券</td>
        </tr>
        <tr>
            <td>CouponBLService.getUsersByConsume(double totalConsume)</td>
            <td>获取满足一定消费总额的用户</td>
        </tr>
        <tr>
            <td>CouponBLService.presentCoupon2User(PresentForm presentForm)</td>
            <td>批量赠送优惠券</td>
        </tr>
    </table>
</div>

### 5.4 业务逻辑层分解

业务逻辑层包括多个针对控制层模块的业务逻辑模块。例如，usercon会根据用户请求调用userbl模块的服务。业务逻辑层的设计如图12所示。

![](https://s2.ax1x.com/2019/06/17/VbMTBT.png)

<div style="text-align: center">图12 业务逻辑层设计</div>

#### 5.4.1 职责

业务逻辑层的模块职责如表22所示。

<div>
    <table>
        <caption>表22 业务逻辑层模块的职责<caption>
        <hr>
        <tr>
        	<td><strong>模块</strong></td>
            <td><strong>职责</strong></td>
        </tr>
        <tr>
        	<td>HallBL</td>
            <td>负责实现对应的控制层需要的与影厅信息增删改查功能相关的业务逻辑服务</td>
        </tr>
        <tr>
        	<td>ScheduleBL</td>
            <td>负责实现对应的控制层需要的与排片信息相关的业务逻辑服务</td>
        </tr>
        <tr>
        	<td>UserBL</td>
            <td>负责实现对应的控制层需要的与用户相关的业务逻辑服务</td>
        </tr>
        <tr>
        	<td>SalesBL</td>
            <td>负责实现对应的控制层需要的与购票相关的业务逻辑服务</td>
        </tr>
        <tr>
            <td>StatisticsBL</td>
            <td>负责实现对应的控制层需要的与电影统计数据相关的业务逻辑服务</td>
        </tr>
        <tr>
            <td>ConsumeBL</td>
            <td>负责实现对应的控制层需要的与充值消费记录相关的业务逻辑服务</td>
        </tr>
        <tr>
            <td>ActivityBL</td>
            <td>负责实现对应的控制层需要的与优惠活动相关的业务逻辑服务</td>
        </tr>
        <tr>
            <td>CardBL</td>
            <td>负责实现对应的控制层需要的与会员卡相关的业务逻辑服务</td>
        </tr>
        <tr>
            <td>CouponBL</td>
            <td>负责实现对应的控制层需要的与优惠券相关的业务逻辑服务</td>
        </tr>
    </table>
</div>


#### 5.4.2 接口规范

业务逻辑层的接口规范如表23~表31所示。

<div>
    <table>
        <caption><strong>表23 hallbl模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">HallBLService.searchAllHall</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO searchAllHall()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>返回所有影厅信息列表</td>
        </tr>
        <tr>
            <td rowspan="4">HallBLService.addHall</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO addHall(HallVO hallVO)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>hallVO不为空且符合输入规则</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据hallId查询是否存在对应的影厅信息记录，如果有则将对应的影厅信息删除，最后返回删除影厅信息的结果</td>
        </tr>
        <tr>
            <td rowspan="4">HallBLService.updateHall</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO updateHall(HallVO hallVO)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>hallVO不为空且符合输入规则</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据hallVO查询是否已经存在相同的hallName，如果没有则将原来对应的影厅信息更新，最后返回更新影厅信息的结果</td>
        </tr>
        <tr>
            <td rowspan="4">HallBLService.removeHall</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO removeHall(int hallId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据hallId查询是否存在对应的影厅信息记录，如果有则将对应的影厅信息删除，最后返回删除影厅信息的结果</td>
        </tr>
        <tr>
            <td rowspan="4">HallBLService.getAvailableHalls</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getAvailableHalls()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取所有空闲（没有排片）的影厅信息列表</td>
        </tr>
    </table>
<div>
<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>HallDataService.selectAllHall</td>
            <td>获取所有影厅信息列表</td>
        </tr>
        <tr>
            <td>HallDataService.checkHallName</td>
            <td>查询是否存在相同名字的影厅记录</td>
        </tr>
        <tr>
            <td>HallDataService.addHall</td>
            <td>添加影厅信息</td>
        </tr>
        <tr>
            <td>HallDataService.updateHall</td>
            <td>更新影厅信息</td>
        </tr>
        <tr>
            <td>HallDataService.removeHallById</td>
            <td>根据影厅id删除影厅信息</td>
        </tr>
        <tr>
            <td>HallDataService.getHallsExcept</td>
            <td>根据影厅id列表，获取影厅id不属于该id列表的影厅信息列表</td>
        </tr>
        <tr>
            <td>HallDataService.selectHallById</td>
            <td>根据影厅id获取影厅信息</td>
        </tr>
        <tr>
            <td>ScheduleService.getScheduledHalls</td>
            <td>获取当前已经有排片的影厅id列表</td>
        </tr>
    </table>
</div>

<div>
    <table>
        <caption><strong>表24 schedulebl模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">ScheduleServiceForBl.getScheduledHalls</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public List&lt;Integer> getScheduledHalls()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>返回所有已排片的影厅信息列表</td>
        </tr>
    </table>
<div>
    <div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>ScheduleDataService.getHallsInSchedules</td>
            <td>获取数据库中当前没有排片（当前时间晚于电影结束时间）的所有影厅id列表</td>
        </tr>
    </table>
</div>

<div>
    <table>
        <caption><strong>表25 userbl模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4"> UserBL.login </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public User login(UserForm userForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>userName符合输入条件</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据username查找是否存在相应的User，如果username和password相匹配，则建立session会话，最后返回登录验证的结果</td>
        </tr>
        <tr>
            <td rowspan="4"> UserBL.registerAccount </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO registerAccount(UserForm userForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>userFrom符合输入条件</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据UserForm查找是否已经存在对应的username，如果没有，则增加一条新的用户账号记录，最后返回注册的结果</td>
        </tr>
        <tr>
            <td rowspan="4"> UserBL.checkPassword </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO checkPassword(User user, String rawPassword)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>rawPassword符合输入条件</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据用户输入的密码返回验证结果</td>
        </tr>
        <tr>
            <td rowspan="4"> UserBL.editPassword </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO editPassword(UserForm userForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>用户账号存在</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据userForm查找用户的账号并修改账号密码，返回修改的结果</td>
        </tr>
        <tr>
            <td rowspan="4"> UserBL.getAdaptableRoles </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getAdaptableRoles(Integer level)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>输入的等级是有效等级</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>如果等级是有效的，根据等级查找并返回该等级可修改的影院角色</td>
        </tr>
        <tr>
            <td rowspan="4"> UserBL.deleteRole </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO deleteRole(Integer id)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>id符合输入条件</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>如果该id是有效的，根据id查找并删除该影院角色，返回删除结果</td>
        </tr>
        <tr>
            <td rowspan="4"> UserBL.editRole </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO editRole(RoleVO form)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>from符合输入条件</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>修改影院角色并返回修改结果</td>
        </tr>
        <tr>
            <td rowspan="4"> UserBL.addRole </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO addRole(RoleVO form)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>from符合输入条件</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据from添加影院角色，并返回添加结果</td>
        </tr>
    </table>
<div>
<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>UserDataService.createNewAccount(String username, String password, Integer auth)</td>
            <td>注册账号</td>
        </tr>
        <tr>
            <td>UserDataService.getAccountByName( String username)</td>
            <td>根据用户名查找账号</td>
        </tr>
        <tr>
            <td>UserDataService.updatePassword(UserForm userForm)</td>
            <td>修改密码</td>
        </tr>
        <tr>
            <td>UserDataService.getCinemaRoles()</td>
            <td>获取全部影院角色</td>
        </tr>
        <tr>
            <td>UserDataService.deleteRoleById(Integer id)</td>
            <td>删除影院角色</td>
        </tr>
        <tr>
            <td>UserDataService.updateRoleById(Integer id, String username,
                       String password, Integer auth)</td>
            <td>更新角色信息</td>
        </tr>
    </table>
</div>



<div>
    <table>
        <caption><strong>表26 salesbl模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4"> SalesBL.completeByVIPCard </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO completeByVIPCard(List<Integer> id, int couponId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>id不为空</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据ticket查找是否存在相应的会员卡，根据couponId查找是否存在相应的优惠券，存在则完成购买电影票流程，返回购买结果</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesBL.addTicket </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO addTicket(TicketForm ticketForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>ticketFrom符合条件</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据ticketFrom锁座，返回锁座结果</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesBL.completeTicket </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO completeTicket(List<Integer> id, int couponId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>id不为空</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据ticketAndCouponVO查找并购买电影票，并返回购票结果</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesBL.getTicketByUser </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getTicketByUser(int userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>userId有效</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据userId查找并返回用户买过的电影票</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesBL.getBySchedule </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getBySchedule(int scheduleId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>scheduleId是有效id</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据scheduleId查找并返回该排片的锁座情况</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesBL.cancelTicket </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO cancelTicket(List<Integer> id)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>id不为空</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据ticketId查找并删除电影票，返回删除结果</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesBL.issueTicket </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO issueTicket(int id)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>id为有效电影票id</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据ticketId查找并修改电影票状态为出票，返回出票结果</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesBL.getAllRefund </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getAllRefund()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取并返回所有退票策略</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesBL.publishRefund </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO publishRefund(RefundForm refundForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>refundFrom符合输入条件</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据refundFrom新增一条退票策略，返回新增结果</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesBL.deleteRefund </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO deleteRefund(int refundId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>refundId存在</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据refundId查找并删除退票策略，返回删除结果</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesBL.getRefundById </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getRefundById(int refundId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>refundId存在</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据refundId查找并返回退票策略</td>
        </tr>
    </table>
<div>
<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>SalesDataService.insertTicket(Ticket ticket)</td>
            <td>添加单张电影票</td>
        </tr>
        <tr>
            <td>SalesDataService.insertTickets(List<Ticket> tickets)</td>
            <td>添加多张电影票</td>
        </tr>
        <tr>
            <td>SalesDataService.deleteTicket(int ticketId)</td>
            <td>删除电影票</td>
        </tr>
        <tr>
            <td>SalesDataService.selectTicketByUser(int userId)</td>
            <td>获得用户买过的票</td>
        </tr>
        <tr>
            <td>SalesDataService.deleteLockedTicket(int userId, int scheduleId)</td>
            <td>删除被锁座位的票</td>
        </tr>
        <tr>
            <td>SalesDataService.updateTicketState(int ticketId, int state)</td>
            <td>更新电影票状态</td>
        </tr>
        <tr>
            <td>SalesDataService.updateTicketActualPay(int ticketId, double actualPay)</td>
            <td>更新票的实际支付金额</td>
        </tr>
        <tr>
            <td>SalesDataService.selectTicketsBySchedule(int scheduleId)</td>
            <td>根据排片获取电影票</td>
        </tr>
        <tr>
            <td>SalesDataService.selectTicketByScheduleIdAndSeatint scheduleId, int columnIndex, int rowIndex)</td>
            <td>根据排片和座位获取电影票</td>
        </tr>
        <tr>
            <td>SalesDataService.selectTicketById(int id)</td>
            <td>根据id获取电影票</td>
        </tr>
        <tr>
            <td>SalesDataService.selectRefund()</td>
            <td>获得所有退票策略</td>
        </tr>
        <tr>
            <td>SalesDataService.insertRefund(Refund refund)</td>
            <td>新增退票策略</td>
        </tr>
        <tr>
            <td>SalesDataService.deleteRefundById(int refundId)</td>
            <td>根据id删除一条退票策略</td>
        </tr>
        <tr>
            <td>SalesDataService.selectRefundByMovieId(int movieId)</td>
            <td>根据电影获取退票策略</td>
        </tr>
        <tr>
            <td>SalesDataService.selectRefundById(int refundId)</td>
            <td>根据id获取退票策略</td>
        </tr>
    </table>
</div>

<div>
    <table>
        <caption><strong>表27 statisticsbl模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">StatisticsBL.likeMovie</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO likeMovie(int userId, int movieId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>标记电影为想看</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsBL.unLikeMovie</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO unlikeMovie(int userId, int movieId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>取消电影为想看</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsBL.getCountOfLikes</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getCountOfLikes(int movieId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>统计想看电影的人数</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsBL.getLikeNumsGroupByDate</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getLikeNumsGroupByDate(int movieId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获得电影每日的想看人数</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsBL.getScheduleRateByDate</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getScheduleRateByDate(Date date)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取某日各影片排片率统计数据</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsBL.getTotalBoxOffice</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getTotalBoxOffice()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取所有电影的累计票房(降序排序，且包含已下架的电影)</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsBL.getAudiencePriceSevenDays</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getAudiencePriceSevenDays()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获得过去7天内每天客单价</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsBL.getMoviePlacingRateByDate</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getMoviePlacingRateByDate(Date date)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取所有电影某天的上座率</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsBL.getPopularMovies</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getPopularMovies(int days, int movieNum)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取最近days天内，票房最高的的movieNum个电影</td>
        </tr>
    </table>
<div>


<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>StatisticsDataService.insertOneLike(int movieId,int userId)</td>
            <td>插入一条想看记录</td>
        </tr>
        <tr>
        	<td>StatisticsDataService.deleteOneLike(int movieId,int userId)</td>
            <td>删除一条想看记录</td>
        </tr>
         <tr>
        	<td>StatisticsDataService.selectLikeNums(int movieId)</td>
            <td>根据movieId查看电影的想看人数</td>
        </tr>
         <tr>
        	<td>StatisticsDataService.selectLikeMovie(int movieId,int userId)</td>
            <td>根据movieId和userId查找特定想看记录</td>
        </tr>
         <tr>
        	<td>StatisticsDataService.selectMovieScheduleTimes(Date date, Date nextDate)</td>
            <td>查询date当天每部电影的排片次数</td>
        </tr>
        <tr>
        	<td>StatisticsDataService.getDateLikeNum(int movieId)</td>
            <td>根据movieId获取按日期统计的想看人数</td>
        </tr>
        <tr>
        	<td>StatisticsDataService.selectMovieTotalBoxOffice()</td>
            <td>查询所有电影的总票房（包括已经下架的，降序排列）</td>
        </tr>
        <tr>
        	<td>StatisticsDataService.selectAudiencePrice(Date date,Date nextDate)</td>
            <td>查询date当天每个客户的购票金额</td>
        </tr>
        <tr>
        	<td>StatisticsDataService.selectPlacingRate(Date date,Date nextDate)</td>
            <td>查询date当天各电影上座率</td>
        </tr>
        <tr>
        	<td>StatisticsDataService.selectRecentTotalBoxOffice(Date startDate,Date today,int num)</td>
            <td>查询startDate到today日期内票房最高的num部电影</td>
        </tr>
    </table>
</div>


<div>
    <table>
        <caption><strong>表28 consumebl模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">ConSumeBL.getAllTopUpHistory</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getAllTopUpHistory(Integer userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取用户全部的充值记录</td>
        </tr>
        <tr>
            <td rowspan="4">ConSumeBL.getBriefConsumeHis</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getBriefConsumeHis(Integer userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取用户简略消费记录信息</td>
        </tr>
        <tr>
            <td rowspan="4">ConSumeBL.getConsumeHisDetail</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getConsumeHisDetail(Integer id)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取用户消费记录详细信息</td>
        </tr>
        <tr>
            <td rowspan="4">ConSumeBL.addTopUpHistory</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO addTopUpHistory(Integer userId, Double money, Double discount, Double balance, Timestamp time)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>添加充值记录</td>
        </tr>
        <tr>
            <td rowspan="4">ConSumeBL.addConsumeHistory</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO addConsumeHistory(Integer userId, Double money, Double discount, String consumeType,Integer type, Integer contentId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>添加消费记录</td>
        </tr>
        <tr>
            <td rowspan="4">ConSumeBL.getConsumeQualifiedUsers</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ResponseVO getConsumeQualifiedUsers(Double totalConsume)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取消费总额满一定值的用户信息</td>
        </tr>
    </table>
<div>
<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>ConsumeDateService.getTopUpHistoryByUserId(Integer userId)</td>
            <td>根据userId获取此用户的充值记录列表，若无记录则返回空</td>
        </tr>
        <tr>
        	<td>ConsumeDateService.getConsumeHistoryByUserId(Integer userId)</td>
            <td>根据userId获取此用户的消费记录列表，若无记录则返回空</td>
        </tr>
         <tr>
        	<td>ConsumeDateService.getConsumeHistoryById(Integer id)</td>
            <td>根据id获取消费记录</td>
        </tr>
         <tr>
        	<td>ConsumeDateService.insertTopUpHistory(Integer userId, Double money,Double discount,Double balance,Timestamp time)</td>
            <td>插入新的充值记录</td>
        </tr>
         <tr>
        	<td>ConsumeDateService.insertConsumeHistory(Integer userId, Double money,Double discount,String consumeType,Integer type,Integer contentId)</td>
            <td>插入新的消费记录</td>
        </tr>
        <tr>
        	<td>ConsumeDateService.selectConsumeQulifiedUsers(Double totalConsume)</td>
            <td>获得消费总额大于totalConsume的用户</td>
        </tr>
        <tr>
        	<td>HallServiceForBl.getHallById(int id)</td>
            <td>获得指定影厅信息</td>
        </tr>
        <tr>
        	<td>MovieServiceForBl.getMovieById(int id)</td>
            <td>获得指定电影信息</td>
        </tr>
        <tr>
        	<td>ScheduleServiceForBl.getScheduleItemById(int id)</td>
            <td>获得指定排片信息</td>
        </tr>
        <tr>
        	<td>VipService.getCardById(int id)</td>
            <td>获得指定会员卡信息</td>
        </tr>
        <tr>
        	<td>TicketServiceForBl.getTicketById(int id)</td>
            <td>获得指定电影票信息</td>
        </tr>
    </table>
</div>

<div>
    <table>
        <caption><strong>表29 activitybl模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">ActivityBL.publishActivity</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO publishActivity(ActivityForm activityForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>activityForm格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>发布一个优惠活动</td>
        </tr>
        <tr>
            <td rowspan="4">ActivityBL.getActivities</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getActivities()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取所有优惠活动信息</td>
        </tr>
        <tr>
            <td rowspan="4">ActivityBL.deleteActivity</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO deleteActivity(int activityId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>activityId格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>删除优惠活动</td>
        </tr>
        <tr>
            <td rowspan="4">ActivityBL.getActivityById</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getActivityById(int activityId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>activityId格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取指定id的优惠活动</td>
        </tr>
    </table>
<div>


<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>ActivityDataService.insertActivity(Activity activity)</td>
            <td>在数据库中插入一个优惠活动</td>
        </tr>
        <tr>
            <td>
                ActivityDataService.insertActivityAndMovie(int activityId,List&lt;Integer&gt; movieId)
            </td>
            <td>在数据库中插入一条活动和电影的关系</td>
        </tr>
        <tr>
            <td>ActivityDataService.selectActivities()</td>
            <td>返回所有优惠活动信息</td>
        </tr>
        <tr>
            <td>ActivityDataService.selectActivitiesByMovie(int movieId)</td>
            <td>返回特定电影的优惠活动信息</td>
        </tr>
        <tr>
            <td>ActivityDataService.selectById(int id)</td>
            <td>获取指定id的优惠活动</td>
        </tr>
        <tr>
            <td>ActivityDataService.deleteActivityById(int id)</td>
            <td>删除指定的优惠活动</td>
        </tr>
        <tr>
            <td>ActivityDataService.deleteActivityAndMovie(int id)</td>
            <td>根据活动id删除活动和电影关系</td>
        </tr>
    </table>
</div>


<div>
    <table>
        <caption><strong>表30 cardbl模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">CardTypeBL.getCards</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getCards()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取所有会员卡类型</td>
        </tr>
        <tr>
            <td rowspan="4">CardTypeBL.publishCard</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO publishCard(CardTypeForm cardTypeForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>cardTypeForm信息格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>发布会员卡类型</td>
        </tr>
        <tr>
            <td rowspan="4">CardTypeBL.deleteCard</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO deleteCard(int cardId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>cardId格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>删除会员卡类型</td>
        </tr>
        <tr>
            <td rowspan="4">CardTypeBL.updateCard</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO updateCard(int cardId, CardTypeForm cardTypeForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>cardId和cardTypeForm格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>更新会员卡类型信息</td>
        </tr>
        <tr>
            <td rowspan="4">VIPCardBL.addVIPCard</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO addVIPCard(int userId, int cardTypeId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>userId和cardTypeId格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>为指定用户增加会员卡</td>
        </tr>
        <tr>
            <td rowspan="4">VIPCardBL.getCardByUserId</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getCardByUserId(int userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>userId格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取某用户的有效会员卡</td>
        </tr>
        <tr>
            <td rowspan="4">VIPCardBL.charge</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO charge(VIPCardForm vipCardForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>vipCardForm格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>为指定会员卡充值制定金额</td>
        </tr>
        <tr>
            <td rowspan="4">VIPCardBL.changeVIPCard</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO changeVIPCard(int cardId, int cardTypeId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>cardId和carTypeId格式真确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>更换指定用户的会员卡类型</td>
        </tr>
    </table>
<div>


<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>CardTypeDataService.selectAllCards()</td>
            <td>获取所有会员卡类型</td>
        </tr>
        <tr>
            <td>CardTypeDataService.insertOneCard(CardType cardType)</td>
            <td>在数据库中插入会员卡类型</td>
        </tr>
        <tr>
            <td>CardTypeDataService.deleteCardById(int cardId)</td>
            <td>在数据库中删除会员卡类型，将会员卡类型状态设为0</td>
        </tr>
        <tr>
            <td>CardTypeDataService.updateCardById(int cardId, CardType cardType)</td>
            <td>更新会员卡类型信息</td>
        </tr>
        <tr>
            <td>VIPCardDataService.insertOneCard(VIPCard vipCard)</td>
            <td>为指定用户增加会员卡</td>
        </tr>
        <tr>
            <td>VIPCardDataService.selectCardByUserId(int userId)</td>
            <td>获取某用户的有效会员卡</td>
        </tr>
        <tr>
            <td>VIPCardDataService.updateCardBalance(int id, double balance)</td>
            <td>为指定会员卡更新余额</td>
        </tr>
        <tr>
            <td>VIPCardDataService.selectCardById(int id)</td>
            <td>获取指定id的会员卡</td>
        </tr>
        <tr>
            <td>VIPCardDataService.deleteCardById(int cardId)</td>
            <td>从数据库中删除指定id的会员卡，将状态设置为0</td>
        </tr>
    </table>
</div>


<div>
    <table>
        <caption><strong>表31 couponbl模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4"> CouponBL.getAllCoupons </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getAllCoupons()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>管理员准备赠送优惠券</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取所有优惠券</td>
        </tr>
        <tr>
            <td rowspan="4"> CouponBL.getUsersByConsume </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getUsersByConsume(double totalConsume)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>totalConsume符合输入规范</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取满足一定消费总额的用户</td>
        </tr>
        <tr>
            <td rowspan="4"> CouponBL.presentCoupon2User </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO presentCoupon2User(PresentForm presentForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>presentForm符合输入规范</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>批量赠送优惠券</td>
        </tr>
        <tr>
            <td rowspan="4"> CouponBL.getCouponsByUser </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO getCouponsByUser(int userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>userId存在</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>返回用户拥有的有效优惠券</td>
        </tr>
        <tr>
            <td rowspan="4"> CouponBL.addCoupon </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public ResponseVO addCoupon(CouponForm couponForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>couponForm符合输入规范</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>发布新优惠券</td>
        </tr>
    </table>
<div>


<div>
    <table>
        <caption><strong>需要的服务（需接口）</strong></caption>
        <tr>
            <td><strong>服务名</strong></td>
            <td><strong>服务</strong></td>
        </tr>
        <tr>
            <td>ConsumeBL.getConsumeQualifiedUsers(double totalConsume)</td>
            <td>获取满足一定消费总额的用户</td>
        </tr>
        <tr>
            <td>CouponDataService.selectAllCoupons()</td>
            <td>获取所有有效优惠券</td>
        </tr>
        <tr>
            <td>CouponDataService.insertCouponUser(int couponId,int userId)</td>
            <td>赠送某种优惠券给某个用户</td>
        </tr>
        <tr>
            <td>CouponDataService.insertCoupon(Coupon coupon)</td>
            <td>在数据库中插入优惠券</td>
        </tr>
        <tr>
            <td>CouponDataService.selectCouponByUser(int userId)</td>
            <td>获取用户拥有的所有有效优惠券</td>
        </tr>
    </table>
</div>

### 5.5 数据层分解

数据层主要给业务逻辑层提供数据访问服务，包括对于持久化数据的增、删、改、查。例如，业务逻辑模块userbl需要的服务由userdataservice接口提供。userdataservice接口通过mybatis绑定同名xml文件实现。持久化数据的保存通过mysql数据库的形式。数据层模块的描述具体设计如图13~19所示。


![](https://i.loli.net/2019/06/02/5cf38139ced5531465.png)

<div style="text-align: center">图13 userdata模块设计图</div>

![](https://i.loli.net/2019/06/02/5cf38139ea69763160.png)

<div style="text-align: center">图14 salesdata模块设计图</div>

![](https://s2.ax1x.com/2019/06/19/VXQssA.png)

<div style="text-align: center">图15 statisticsdata模块设计图</div>

![](https://s2.ax1x.com/2019/06/19/VXQvz4.png)

<div style="text-align: center">图16 consumedata模块设计图</div>

![](https://s2.ax1x.com/2019/06/05/VNqMAH.png)

<div style="text-align: center">图17 activitydata模块设计图</div>

![](https://s2.ax1x.com/2019/06/05/VNqcuT.png)

<div style="text-align: center">图18 carddata模块设计图</div>

![](https://s2.ax1x.com/2019/06/05/VNqgDU.png)

<div style="text-align: center">图19 coupondata模块设计图</div>

#### 5.5.1 职责

数据层模块的职责如表32所示。

<div>
    <table>
        <caption><strong>表32 数据层模块的职责</strong><caption>
        <hr>
        <tr>
        	<td><strong>模块</strong></td>
            <td><strong>职责</strong></td>
        </tr>
        <tr>
        	<td>HallData</td>
            <td>提供与影厅信息数据相关的增、删、改、查服务</td>
        </tr>
        <tr>
        	<td>ScheduleData</td>
            <td>提供与排片信息数据相关的增、删、改、查服务</td>
        </tr>
        <tr>
        	<td>UserData</td>
            <td>提供用户数据的插入、查询服务</td>
        </tr>
        <tr>
        	<td>SalesData</td>
            <td>提供电影票数据及退票策略数据的插入、查询服务</td>
        </tr>
        <tr>
            <td>StatisticsData</td>
            <td>提供电影统计数据获取，添加，删除的服务</td>
        </tr>
        <tr>
            <td>ConsumeDate</td>
            <td>提供消费充值记录的插入，查询的服务</td>
        </tr>
        <tr>
            <td>ActivityData</td>
            <td>提供与优惠活动相关的增、删、改、查服务</td>
        </tr>
        <tr>
            <td>CardData</td>
            <td>提供与会员卡相关的插入、修改、查询服务</td>
        </tr>
        <tr>
            <td>CouponData</td>
            <td>提供与优惠券相关的增、删、改、查服务</td>
        </tr>
    </table>
</div>





#### 5.5.2 接口规范
数据层模块的接口规范如表33~41所示。

<div>
    <table>
        <caption><strong>表33 scheduledata模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">ScheduleDataService.getHallsInSchedules</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ScheduleDataService.getHallsInSchedules()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取数据库中当前没有排片（当前时间晚于电影结束时间）的所有影厅id列表并返回</td>
        </tr>
    </table>
<div>



<div>
    <table>
        <caption><strong>表34 halldata模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">HallDataService.selectAllHall</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public List&lt;Hall> selectAllHall()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取数据库中所有影厅记录列表并返回</td>
        </tr>
        <tr>
            <td rowspan="4">HallDataService.selectHallById</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public Hall selectHallById(int hallId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据hallId获取数据库中对应的影厅信息记录并返回</td>
        </tr>
        <tr>
            <td rowspan="4">HallDataService.addHall</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public int addHall(Hall hall)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>hall不为null且符合输入格式</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据hall往数据库中添加一条影厅信息记录，添加成功则返回1，否则返回0</td>
        </tr>
        <tr>
            <td rowspan="4">HallDataService.removeHallById</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public int removeHallById(int hallId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据hallId从数据库中将对应的影厅信息记录删除，删除成功则返回1，否则返回0</td>
        </tr>
        <tr>
            <td rowspan="4">HallDataService.updateHall</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public int updateHall(Hall hall)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据hall在数据库中更新对应的影厅信息记录，更新成功则返回1，否则返回0</td>
        </tr>
        <tr>
            <td rowspan="4">HallDataService.getHallsExcept</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public List&lt;Hall> getHallsExcept(List<Integer> hallIds)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>hallIds不为空</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>在数据库中查找id不在hallIds列表中的对应的影厅记录列表并返回</td>
        </tr>
        <tr>
            <td rowspan="4">HallDataService.checkHallName</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>public int checkHallName(String hallName, int hallId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>hallName不为空</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>在数据库中查找id为hallId、影厅名称为hallName的影厅信息记录条数并返回</td>
        </tr>        
    </table>
<div>

<div>
    <table>
        <caption><strong>表35 userdata模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4"> UserDataService.createNewAccount </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int createNewAccount(String username, String password, Integer auth)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>输入参数不为空</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据username，password和auth新建一个用户账号</td>
        </tr>
        <tr>
            <td rowspan="4"> UserDataService.getAccountByName </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>User getAccountByName(String username)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据用户名查找并返回一个账号</td>
        </tr>
        <tr>
            <td rowspan="4"> UserDataService.updatePassword </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int updatePassword(UserForm userForm)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>更新用户密码，并返回更新结果</td>
        </tr>
        <tr>
            <td rowspan="4"> UserDataService.getCinemaRoles </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List<User> getCinemaRoles()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取并返回全部影院角色</td>
        </tr>
        <tr>
            <td rowspan="4"> UserDataService.deleteRoleById </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int deleteRoleById(Integer id)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据id删除一个角色，并返回删除结果</td>
        </tr>
        <tr>
            <td rowspan="4"> UserDataService.getAccountByName </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int updateRoleById(Integer id, String username, String password, Integer auth)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>更新角色信息并返回更新结果</td>
        </tr>
    </table>
<div>



<div>
    <table>
        <caption><strong>表36 salesdata模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4"> SalesDataService.insertTicket</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int insertTicket(Ticket ticket)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>新增一张电影票</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesDataService.insertTickets </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int insertTickets(List<Ticket> tickets)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>新增多张电影票并返回新增结果</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesDataService.deleteTicket </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>void deleteTicket(int ticketId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>删除一张电影票</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesDataService.deleteLockedTicket </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>void deleteLockedTicket(int userId, int scheduleId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>删除被锁的票</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesDataService.updateTicketState </td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>void updateTicketState(int ticketId, int state)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>更新电影票状态</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesDataService.updateTicketActualPay</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>void updateTicketActualPay(int ticketId, double actualPay)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>更新电影票实际支付金额</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesDataService.selectTicketsBySchedule</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List<Ticket> selectTicketsBySchedule(int scheduleId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据排片查找并返回电影票</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesDataService.selectTicketByScheduleIdAndSeat</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>Ticket selectTicketByScheduleIdAndSeat(int scheduleId, int columnIndex, int rowIndex)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据排片和座位查找并返回电影票</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesDataService.selectTicketById</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>Ticket selectTicketById(int id)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据id查找并返回电影票</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesDataService.selectRefund</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List<Refund> selectRefund()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>查找并返回所有退票策略</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesDataService.insertRefund</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>void insertRefund(Refund refund)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>添加一条退票策略</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesDataService.deleteRefundById</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>void deleteRefundById(int refundId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据id删除一条退票策略</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesDataService.selectRefundByMovieId</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List<Refund> selectRefundByMovieId(int movieId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据电影id查找并返回退票策略</td>
        </tr>
        <tr>
            <td rowspan="4"> SalesDataService.selectRefundById</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>Refund selectRefundById(int refundId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据id查找并返回退票策略</td>
        </tr>
    </table>
<div>

<div>
    <table>
        <caption><strong>表37 statisticsdata模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">StatisticsDataService.insertOneLike</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int insertOneLike(int movieId,int userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>插入一条想看记录</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsDataService.deleteOneLike</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int deleteOneLike(int movieId,int userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>删除一条想看记录</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsDataService.selectLikeNums</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int selectLikeNums(int movieId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据movieId查看电影的想看人数</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsDataService.selectLikeMovie</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int selectLikeMovie(int movieId,int userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据movieId和userId查找特定想看记录</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsDataService.getDateLikeNum</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List&ltDateLike&gt getDateLikeNum(int movieId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据movieId获取按日期统计的想看人数</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsDataService.selectMovieScheduleTimes</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List&ltMovieScheduleTime&gt selectMovieScheduleTimes(Date date, Date nextDate)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>查询date当天每部电影的排片次数</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsDataService.selectMovieTotalBoxOffice</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List&ltMovieTotalBoxOffice&gt selectMovieTotalBoxOffice()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>查询所有电影的总票房（包括已经下架的，降序排列）</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsDataService.selectAudiencePrice</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List&ltAudiencePrice&gt selectAudiencePrice(Date date,Date nextDate)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>查询date当天每个客户的购票金额</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsDataService.selectPlacingRate</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List&ltPlacingRateVO&gt selectPlacingRate(Date date,Date nextDate)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>查询date当天各电影上座率</td>
        </tr>
        <tr>
            <td rowspan="4">StatisticsDataService.selectRecentTotalBoxOffice</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List&ltMovieTotalBoxOffice&gt selectRecentTotalBoxOffice(Date startDate,Date today,int num)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>查询startDate到today日期内票房最高的num部电影</td>
        </tr>
    </table>
</div>

<div>
    <table>
        <caption><strong>表38 consumedata模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">ConsumeDateService.getTopUpHistoryByUserId</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List&ltTopUpHistory&gt getTopUpHistoryByUserId(Integer userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据userId获取此用户的充值记录列表，若无记录则返回空</td>
        </tr>
        <tr>
            <td rowspan="4">ConsumeDateService.getConsumeHistoryByUserId</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List&ltConsumeHistory&gt getConsumeHistoryByUserId(Integer userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据userId获取此用户的消费记录列表，若无记录则返回空</td>
        </tr>
        <tr>
            <td rowspan="4">ConsumeDateService.getConsumeHistoryById</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>ConsumeHistory getConsumeHistoryById(Integer id)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据id获取消费记录</td>
        </tr>
        <tr>
            <td rowspan="4">ConsumeDateService.insertTopUpHistory</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int insertTopUpHistory(Integer userId, Double money,Double discount,Double balance,Timestamp time)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>插入新的充值记录</td>
        </tr>
        <tr>
            <td rowspan="4">ConsumeDateService.insertConsumeHistory</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int insertConsumeHistory(Integer userId, Double money,Double discount,String consumeType,Integer type,Integer contentId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>插入新的消费记录</td>
        </tr>
        <tr>
            <td rowspan="4">ConsumeDateService.selectConsumeQulifiedUsers</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List&ltTotalConsumeUser&gt selectConsumeQulifiedUsers(Double totalConsume)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获得消费总额大于totalConsume的用户</td>
        </tr>
    </table>
</div>

<div>
    <table>
        <caption><strong>表39 activitydata模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">ActivityDataService.insertActivity</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int insertActivity(Activity activity)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>activity格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>在数据库中插入一个优惠活动</td>
        </tr>
        <tr>
            <td rowspan="4">ActivityDataService.insertActivityAndMovie</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>
                int insertActivityAndMovie(int activityId,List&lt;Integer&gt; movieId)
            </td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>activityId和movieId格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>在数据库中插入一条活动和电影的关系</td>
        </tr>
        <tr>
            <td rowspan="4">ActivityDataService.selectActivities</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List&lt;Activity&gt; selectActivities()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>返回所有优惠活动信息</td>
        </tr>
        <tr>
            <td rowspan="4">ActivityDataService.selectActivitiesByMovie</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List&lt;Activity&gt; selectActivitiesByMovie(int movieId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>movieId格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>返回特定电影的优惠活动信息</td>
        </tr>
        <tr>
            <td rowspan="4">ActivityDataService.selectById</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>Activity selectById(int id)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>id格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取指定id的优惠活动</td>
        </tr>
        <tr>
            <td rowspan="4">ActivityDataService.deleteActivityById</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>void deleteActivityById(int id)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>id格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>删除指定的优惠活动</td>
        </tr>
        <tr>
            <td rowspan="4">ActivityDataService.deleteActivityAndMovie</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>void deleteActivityAndMovie(int id)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>id格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>根据活动id删除活动和电影关系</td>
        </tr>
    </table>
<div>



<div>
    <table>
        <caption><strong>表40 carddata模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">CardTypeDataService.selectAllCards</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List&lt;CardType&gt; selectAllCards()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取所有会员卡类型</td>
        </tr>
        <tr>
            <td rowspan="4">CardTypeDataService.insertOneCard</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int insertOneCard(CardType cardType)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>cardTypeForm信息格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>在数据库中插入会员卡类型</td>
        </tr>
        <tr>
            <td rowspan="4">CardTypeDataService.deleteCardById</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int deleteCardById(int cardId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>cardId格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>在数据库中删除会员卡类型，将会员卡类型状态设为0</td>
        </tr>
        <tr>
            <td rowspan="4">CardTypeDataService.updateCardById</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int updateCardById(int cardId, CardType cardType)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>cardId和cardTypeForm格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>更新会员卡类型信息</td>
        </tr>
        <tr>
            <td rowspan="4">VIPCardDataService.insertOneCard</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int insertOneCard(VIPCard vipCard)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>vipCard格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>为指定用户增加会员卡</td>
        </tr>
        <tr>
            <td rowspan="4">VIPCardDataService.selectCardByUserId</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>VIPCard selectCardByUserId(int userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>userId格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取某用户的有效会员卡</td>
        </tr>
        <tr>
            <td rowspan="4">VIPCardDataService.updateCardBalance</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>void updateCardBalance(int id, double balance)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>id和balance格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>为指定会员卡更新余额</td>
        </tr>
        <tr>
            <td rowspan="4">VIPCardDataService.selectCardById</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>VIPCard selectCardById(int id)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>id正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>获取指定id的会员卡</td>
        </tr>
        <tr>
            <td rowspan="4">VIPCardDataService.deleteCardById</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int deleteCardById(int cardId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>cardId正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>从数据库中删除指定id的会员卡，将状态设置为0</td>
        </tr>
    </table>
<div>




<div>
    <table>
        <caption><strong>表41 coupondata模块的接口规范</strong><caption>
        <hr/>
        <caption><strong>提供的服务（供接口）</strong><caption>
        <tr>
            <td rowspan="4">CouponDataService.selectAllCoupons</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List&lt;Coupon&gt; selectAllCoupons()</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>无</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>返回所有有效优惠券</td>
        </tr>
        <tr>
            <td rowspan="4">CouponDataService.insertCouponUser</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>void insertCouponUser(int couponId,int userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>用户id和优惠券id存在</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>在数据库中插入优惠券与用户关系</td>
        </tr>
        <tr>
            <td rowspan="4">CouponDataService.selectById</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>Coupon selectById(int id);</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>优惠券id存在</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>返回特定id的优惠券</td>
        </tr>
        <tr>
            <td rowspan="4">CouponDataService.selectAllCoupons</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>List&lt;Coupon&gt; selectCouponByUser(int userId)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>userId存在</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>返回某个用户所拥有的有效优惠券</td>
        </tr>
        <tr>
            <td rowspan="4">CouponDataService.insertCoupon</td>
        </tr>
        <tr>
            <td><strong>语法</strong></td>
            <td>int insertCoupon(Coupon coupon)</td>
        </tr>
        <tr>
            <td><strong>前置条件</strong></td>
            <td>coupon格式正确</td>
        </tr>
        <tr>
            <td><strong>后置条件</strong></td>
            <td>在数据库中插入优惠券</td>
        </tr>
    </table>
<div>

### 5.6 信息视角

#### 5.6.1 数据持久化对象

系统的PO类就是对应的相关实体类，其定义见下，getter/setter及一些辅助方法略去。

- Hall类属性：影厅id、名称，座位排布，规模

```java
public class Hall {
	private Integer id;
	private String name;
	private String seats;
	private Integer scale;
}
```

- User类属性：身份，账户id，用户名，用户密码

```java
public class User {
    private Integer id;
    private String username;
    private String password;
    private Integer auth;
}
```

- Ticket类属性：电影票id，用户id，排片id，列号，排号，订单状态，实付款，付款时间

```java
public class Ticket {
    private int id;
    private int userId;
    private int scheduleId;
    private int columnIndex;
    private int rowIndex;
    private int state;
    private double actualPay;
    private Timestamp time;
}
```

- Refund类属性：id，电影id，适用时间，折算策略

```java
public class Refund {
    private int id;
    private int movieId;
    private int time;
    private int price;
}
```

- Coupon类属性：优惠券id，优惠券描述，优惠券名称，使用门槛，优惠金额，可用时间、失效时间

```java
public class Coupon {
    private int id;
    private String description;
    private String name;
    private double targetAmount;
    private double discountAmount;
    private Timestamp startTime;
    private Timestamp endTime;
}
```

- CardType类属性：会员卡类型id，会员卡名称，会员卡描述，购买价格，充值需满金额，充值优惠金额，购票需满金额，购票优惠金额

```java
public class CardType {
    private int id;
    private String name;
    private String description;
    private double price;
    private double topUpTarget;
    private double topUpDiscount;
    private double ticketTarget;
    private double ticketDiscount;
}
```

- VIPCard类属性：会员卡id，用户id，会员卡类型id，会员卡余额，办卡日期，会员卡类型

```java
public class VIPCard {
    private int userId;
    private int id;
    private int cardTypeId;
    private double balance;
    private Timestamp joinDate;
    private CardType cardType;
}
```

- Activity类属性：活动名称，活动描述，活动开始时间，活动截止时间，优惠电影列表，优惠券规格，活动需满金额

```java
public class Activity {
    private int id;
    private String name;
    private String description;
    private Timestamp startTime;
    private Timestamp endTime;
    private List<Movie> movieList;
    private Coupon coupon;
    private double targetAmount;
}
```

- TopupHistory类属性：id，账户id，充值金额，优惠金额，充值后余额，充值时间

```java
public class TopUpHistory {
    private Integer id;
    private Integer userId;
    private Double money;
    private Double discount;
    private Double balance;
    private Timestamp time;
}
```

- ConsumeHistory类属性：id，账户id，消费金额，优惠金额，消费方式，消费类型，消费内容id

```java
public class ConsumeHistory {
    private Integer id;
    private Integer userId;
    private Double money;
    private Double discount;
    private String consumeType;
    private Integer type;
    private Integer contentId;
}
```



#### 5.6.2 数据库表

第三阶段主要使用的数据库表有：hall表、coupon表、coupon_user、card_type表、vip_card表、activity表、activity_movie表、topup_history表、consume_history表